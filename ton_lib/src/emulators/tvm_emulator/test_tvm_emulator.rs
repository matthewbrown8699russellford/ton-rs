use crate::emulators::tvm_emulator::c7_register::TVMEmulatorC7;
use crate::emulators::tvm_emulator::method_id::TVMMethodId;
use crate::emulators::tvm_emulator::TVMEmulator;
use crate::types::tlb::block_tlb::tvm::VMStack;
use crate::types::tlb::tep_0074::jetton_transfer_msg::JettonTransferMsg;
use crate::types::tlb::tlb_type::TLBType;
use crate::types::ton_address::TonAddress;
use std::ops::Deref;
use std::str::FromStr;
use tokio_test::assert_ok;

const BC_CONFIG_HEX: &'static str = include_str!("../../../../resources/tests/bc_config_key_block_42123611.hex");

#[test]
fn test_tvm_emulator_get_wallet_address() -> anyhow::Result<()> {
    let owner_address = TonAddress::from_str("EQB2BtXDXaQuIcMYW7JEWhHmwHfPPwa-eoCdefiAxOhU3pQg")?;
    let expected = TonAddress::from_str("EQCGY3OVLtD9KRcOsP2ldQDtuY0FMzV7wPoxjrFbayBXc23c")?;

    let master_address = TonAddress::from_str("EQDk2VTvn04SUKJrW7rXahzdF8_Qi6utb0wj43InCu9vdjrR")?;
    let master_code = hex::decode("b5ee9c7201020b010001ed000114ff00f4a413f4bcf2c80b0102016202030202cc040502037a60090a03efd9910e38048adf068698180b8d848adf07d201800e98fe99ff6a2687d007d206a6a18400aa9385d47181a9aa8aae382f9702480fd207d006a18106840306b90fd001812881a28217804502a906428027d012c678b666664f6aa7041083deecbef29385d71811a92e001f1811802600271812f82c207f97840607080093dfc142201b82a1009aa0a01e428027d012c678b00e78b666491646580897a007a00658064907c80383a6465816503e5ffe4e83bc00c646582ac678b28027d0109e5b589666664b8fd80400fe3603fa00fa40f82854120870542013541403c85004fa0258cf1601cf16ccc922c8cb0112f400f400cb00c9f9007074c8cb02ca07cbffc9d05008c705f2e04a12a1035024c85004fa0258cf16ccccc9ed5401fa403020d70b01c3008e1f8210d53276db708010c8cb055003cf1622fa0212cb6acb1fcb3fc98042fb00915be200303515c705f2e049fa403059c85004fa0258cf16ccccc9ed54002e5143c705f2e049d43001c85004fa0258cf16ccccc9ed54007dadbcf6a2687d007d206a6a183618fc1400b82a1009aa0a01e428027d012c678b00e78b666491646580897a007a00658064fc80383a6465816503e5ffe4e840001faf16f6a2687d007d206a6a183faa9040")?;
    let master_data = hex::decode("b5ee9c720102140100037c0002517038f504e10a000801bf6feee5bff07f3238df435d6c58addbe0b3a94bb05cec14a6241566cb3e61750102004a0168747470733a2f2f746172616e74696e692e6465762f73746f6e2f6d6f6f6e2e6a736f6e0114ff00f4a413f4bcf2c80b0302016204050202cc0607001ba0f605da89a1f401f481f481a8610201d408090201480a0b00bb0831c02497c138007434c0c05c6c2544d7c0fc02f83e903e900c7e800c5c75c87e800c7e800c00b4c7e08403e29fa954882ea54c4d167c0238208405e3514654882ea58c511100fc02780d60841657c1ef2ea4d67c02b817c12103fcbc2000113e910c1c2ebcb853600201200c0d020120121301f500f4cffe803e90087c007b51343e803e903e90350c144da8548ab1c17cb8b04a30bffcb8b0950d109c150804d50500f214013e809633c58073c5b33248b232c044bd003d0032c032483e401c1d3232c0b281f2fff274013e903d010c7e801de0063232c1540233c59c3e8085f2dac4f3208405e351467232c7c6600e03f73b51343e803e903e90350c0234cffe80145468017e903e9014d6f1c1551cdb5c150804d50500f214013e809633c58073c5b33248b232c044bd003d0032c0327e401c1d3232c0b281f2fff274140371c1472c7cb8b0c2be80146a2860822625a020822625a004ad822860822625a028062849f8c3c975c2c070c008e00f1011009acb3f5007fa0222cf165006cf1625fa025003cf16c95005cc2391729171e25008a813a08208989680aa008208989680a0a014bcf2e2c504c98040fb001023c85004fa0258cf1601cf16ccc9ed5400705279a018a182107362d09cc8cb1f5230cb3f58fa025007cf165007cf16c9718018c8cb0524cf165006fa0215cb6a14ccc971fb0010241023000e10491038375f040076c200b08e218210d53276db708010c8cb055008cf165004fa0216cb6a12cb1f12cb3fc972fb0093356c21e203c85004fa0258cf1601cf16ccc9ed5400db3b51343e803e903e90350c01f4cffe803e900c145468549271c17cb8b049f0bffcb8b0a0822625a02a8005a805af3cb8b0e0841ef765f7b232c7c572cfd400fe8088b3c58073c5b25c60063232c14933c59c3e80b2dab33260103ec01004f214013e809633c58073c5b3327b55200083200835c87b51343e803e903e90350c0134c7e08405e3514654882ea0841ef765f784ee84ac7cb8b174cfcc7e800c04e81408f214013e809633c58073c5b3327b5520")?;

    let c7 = TVMEmulatorC7::new(master_address, hex::decode(BC_CONFIG_HEX)?)?;
    let mut stack = VMStack::default();
    stack.push_cell_slice(owner_address.to_cell()?);
    let method = TVMMethodId::Name("get_wallet_address".into());

    let mut emulator = TVMEmulator::new(master_code, master_data)?;
    emulator.set_c7(&c7)?;
    let response = emulator.run_method(method, &stack.to_boc(false)?)?;

    let mut result = response.into_result()?;
    let wallet_address = TonAddress::from_cell(result.stack.pop_cell_slice()?.deref())?;
    assert_eq!(expected, wallet_address);
    Ok(())
}

#[test]
fn test_tvm_emulator_send_int_ext_msg() -> anyhow::Result<()> {
    // let address = TonAddress::from_str("EQAW42HutyDem98Be1f27PoXobghh81umTQ-cGgaKVmRLS7-")?; <<-- code/data address
    let code = hex::decode("b5ee9c7201021301000463000114ff00f4a413f4bcf2c80b0102016202030202cb040502037a600f1004f7d0831c02497c0f8007434c0c05c6c2497c0f83e903e900c7e800c5c75c87e800c7e800c00b4c7f4cffb51343500743e903e903e900c00fe8034c034e7f5350c0411cab00578c08aa0841657c1ef2ea3854d57c0cd4d56cd04b1c17cb812407e90350c04bc04780aa0841ef765f7aeb8c08aa0840b1dae5ceeb8c08e6060708090201ce0d0e008a39393a5181c705f2e04904fa40d43020d08060d721fa00304bb0527cf0105028a00744655023c85007cf165005cf165003cf16c9c85006fa02cb00cb9f13cc12ccccc9ed5401fe3a3b3b05fa00fa40f82854120a70542013541403c85004fa0258cf1601cf16ccc922c8cb0112f400f400cb00c9f9007074c8cb02ca07cbffc9d0500ac705f2e04a14a145465412034a99c85007cf165005cf165003cf16c9c85006fa02cb00cb9f13cc12ccccc9ed54f40482103afd461c708018c8cb055005cf1624fa02140a01fe3a5f07048208989680a015bcf2e04b02fa40d3003095c821cf16c9916de28210d1735400708018c8cb055005cf1624fa0214cb6a13cb1f14cb3f23fa443070ba8e33f828440370542013541403c85004fa0258cf1601cf16ccc922c8cb0112f400f400cb00c9f9007074c8cb02ca07cbffc9d0cf16966c227001cb01e2f4000b01fe3b3b27821062dd86f1ba8e3032365161c705f2e04902fa403046755023c85007cf165005cf165003cf16c9c85006fa02cb00cb9f13cc12ccccc9ed54e027821066447dadba8e363334355154c705f2e04970c8cb01c9d017104644155023c85007cf165005cf165003cf16c9c85006fa02cb00cb9f13cc12ccccc9ed54e0270c007acb6a13cb1f5230cb3ff400c98040fb00fa403020d70b01c3008e1f8210d53276db708010c8cb055003cf1622fa0212cb6acb1fcb3fc98042fb00915be2000ac98040fb0000fc821011db408aba8e3031365161c705f2e04902fa403046745023c85007cf165005cf165003cf16c9c85006fa02cb00cb9f13cc12ccccc9ed54e039068210743f8e58ba8e325161c70507c00017b1f2e0497102d430470703c85007cf165005cf165003cf16c9c85006fa02cb00cb9f13cc12ccccc9ed54e05f09840ff2f000950cfe0a005c150804d50500f214013e809633c58073c5b33248b232c044bd003d0032c032483e401c1d3232c0b281f2fff2741de0063232c15633c5a082bebc203e80b2daf333325c7ec020008b0cfe0a005c150804d50500f214013e809633c58073c5b33248b232c044bd003d0032c0327e401c1d3232c0b281f2fff2741c60063232c15633c59c3e80b2dab33260103ec020009badbcf6a2686a00e87d207d207d201801fd00698069cfea6a180823b638fc1400b82a1009aa0a01e428027d012c678b00e78b666491646580897a007a00658064fc80383a6465816503e5ffe4e8400201201112003cab46ed44d0d401d0fa40fa40fa403003fa00d300d39fd4d43010475b6c240040aa2ded44d0d401d0fa40fa40fa403003fa00d300d39fd4d43010476c427f5520")?;
    let data = hex::decode("b5ee9c720102230100050b00033b90684aff1b327c3906d800000000000000000000000000000000000000040102030086801bc72bea2cb2070ee096fea5a30b20dcd60823f1e2427d8ba030e52ac9d45fb184009570aa1bb7d78ae8a80a769915a7fc4adb7332ed4d031c952b928fd6b87e5d9b010300c0040114ff00f4a413f4bcf2c80b1202012005060143bff082eb663b57a00192f4a6ac467288df2dfeddb9da1bee28f6521c8bebd21f1ec007020120080900a40068747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f6f726269742d636861696e2f6272696467652d746f6b656e2d696d6167652f6d61696e2f746f6e2f6574682e706e670201200a0b0201200e0f0141bf4546a6ffe1b79cfdd86bad3db874313dcde2fb05e6a74aa7f3552d9617c79d130c0141bf6ed4f942a7848ce2cb066b77a1128c6a1ff8c43f438a2dce24612ba9ffab8b030d0034004f726269742042726964676520546f6e20457468657265756d000a006f4554480141bf5208def46f5a1d4f9dce66ab309f4a851305f166f91ef79d923ef58e34f9a209100141bf5d01fa5e3c06901c45046c6b2ddcea5af764fea0eed72a10d404f2312ceb247d11004c004f726269742042726964676520546f6b656e206f6e20544f4e20626c6f636b636861696e21000600313802016213140202cb1516001ba0f605da89a1f401f481f481a86102012017180201621c1d020148191a01f1f81e99ffd007d2010f801f6a2687d007d207d206a18289b50a9156382f9716094617ff971612a1a21382a1009aa0a01e428027d012c678b00e78b666491646580897a007a00658064907c80383a6465816503e5ffe4e8027d207a0218fd00106ba4e1007971623bc00c646582a804678b387d010be5b589e641b00b7420c700925f04e001d0d3030171b095135f03f012e0fa40fa4031fa003171d721fa0031fa003002d31f2182100f8a7ea5ba95313459f00fe0218210178d4519ba9631444403f010e0358210595f07bcba9359f011e05f04840ff2f0800115fa443070baf2e14d800ae8210178d4519c8cb1f19cb3f5007fa0222cf165006cf1625fa025003cf16c95005cc2391729171e25008a813a08208989680aa008208989680a0a014bcf2e2c504c98040fb001023c85004fa0258cf1601cf16ccc9ed540201201e1f008148020d721ed44d0fa00fa40fa40d43004d31f218210178d4519ba0282107bdd97deba12b1f2e2c5d33f31fa003013a05023c85004fa0258cf1601cf16ccc9ed54803f73b51343e803e903e90350c0234cffe80145468017e903e9014d6f1c1551cdb5c150804d50500f214013e809633c58073c5b33248b232c044bd003d0032c0327e401c1d3232c0b281f2fff274140371c1472c7cb8b0c2be80146a2860822625a020822625a004ad822860822625a028062849f8c3c975c2c070c008e020212200e33b51343e803e903e90350c01f4cffe803e903d010c1458a85492b1c17cb8b04a30bffcb8b0a0822625a02a8005e805ef3cb8b0e0841ef765f7b232c7f2cfd4017e808873c59400f3c5bd00325c60063232c14933c59c3e80b2dab33260103ec01004f214013e809633c58073c5b3327b552000705279a018a182107362d09cc8cb1f5230cb3f58fa025007cf165007cf16c9718010c8cb0524cf165006fa0215cb6a14ccc971fb0010241023000e10491038375f040076c200b08e218210d53276db708010c8cb055008cf165004fa0216cb6a12cb1f12cb3fc972fb0093356c21e203c85004fa0258cf1601cf16ccc9ed54")?;

    let dst_address = TonAddress::from_str("Ef8CmPZLxWB-9ypeGdGhEqA6ZNLBFUwnqXPH2eUQd_MzbGh_")?;
    let msg = JettonTransferMsg::new(dst_address.to_msg_address_int(), 1u32);

    // send_int_msg
    let mut emulator = TVMEmulator::new(code, data)?;
    let tvm_response = emulator.send_int_msg(msg.to_boc(false)?, 300)?;
    let tvm_result = assert_ok!(tvm_response.into_result());
    assert_eq!(tvm_result.gas_used, 2779);
    assert_eq!(tvm_result.vm_exit_code, 65535);

    // send_ext_msg
    let tvm_response = emulator.send_ext_msg(msg.to_boc(false)?)?;
    let tvm_result = assert_ok!(tvm_response.into_result());
    assert_eq!(tvm_result.gas_used, 270);
    assert_eq!(tvm_result.vm_exit_code, 11);
    Ok(())
}
